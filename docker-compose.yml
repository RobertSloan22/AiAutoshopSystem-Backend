version: '3.8'

services:
  backend:
    image: robertsloan2023mit/autoshop-backend:latest
    build:
      context: .
      dockerfile: Dockerfile
    platform: linux/amd64  # Ensure compatibility with Mac M1/M2
    container_name: automotive-diagnostics-ai
    ports:
      - "5005:5005"     
      - "3001:3001"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - autoshop-network
    healthcheck:        
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5005/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s     
      timeout: 10s      
      retries: 3        
      start_period: 60s 

  mongodb:
    image: mongo:7      
    container_name: autoshop-mongodb
    platform: linux/amd64  # Ensure compatibility with Mac M1/M2        
    ports:
      - "27017:27017"   
    environment:        
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}        
      MONGO_INITDB_DATABASE: autoshop
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - autoshop-network
    restart: unless-stopped
    healthcheck:        
      test: ["CMD", "mongosh", "--username", "${MONGO_USERNAME:-admin}", "--password", "${MONGO_PASSWORD:-password123}", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]     
      interval: 30s     
      timeout: 10s      
      retries: 5        
      start_period: 40s 

  redis:
    image: redis:7-alpine
    container_name: autoshop-redis
    platform: linux/amd64  # Ensure compatibility with Mac M1/M2        
    ports:
      - "6379:6379"     
    volumes:
      - redis_data:/data
    networks:
      - autoshop-network
    restart: unless-stopped
    command: redis-server --bind 0.0.0.0 --protected-mode yes --requirepass ${REDIS_PASSWORD:-redis123} --maxmemory 256mb --maxmemory-policy allkeys-lru --appendonly yes --appendfsync everysec --notify-keyspace-events Ex
    environment:
      - REDIS_REPLICATION_MODE=master
    healthcheck:        
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis123}", "ping"]        
      interval: 15s     
      timeout: 5s      
      retries: 5        
      start_period: 30s 

  chromadb:
    image: chromadb/chroma:latest
    container_name: autoshop-chromadb
    platform: linux/amd64  # Ensure compatibility with Mac M1/M2        
    ports:
      - "8000:8000"     
    volumes:
      - chromadb_data:/chroma/chroma
    environment:        
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=*      
      - CHROMA_SERVER_HOST=0.0.0.0
    networks:
      - autoshop-network
    restart: unless-stopped
    healthcheck:        
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s     
      timeout: 10s      
      retries: 5        
      start_period: 45s 

networks:
  autoshop-network:     
    driver: bridge      

volumes:
  mongodb_data:
    driver: local       
  redis_data:
    driver: local       
  chromadb_data:        
    driver: local       
